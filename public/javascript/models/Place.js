// Generated by CoffeeScript 1.3.1
(function() {
  var __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor; child.__super__ = parent.prototype; return child; };

  define(['models/Model', 'jquery', 'use!underscore', 'moment'], function(Model, $, _, moment) {
    var Place;
    return Place = (function(_super) {

      __extends(Place, _super);

      Place.name = 'Place';

      function Place() {
        return Place.__super__.constructor.apply(this, arguments);
      }

      Place.prototype.votesKey = 'votesToday';

      Place.prototype.initialize = function() {
        if (this.has('votes')) {
          this.setTodaysVotes();
        }
        return this.on('change:votes', this.setTodaysVotes, this);
      };

      Place.prototype.idAttribute = '_id';

      Place.prototype.vote = function() {
        var _this = this;
        return $.ajax({
          url: '/places/vote/' + this.get('_id'),
          success: function() {
            return _this.set(_this.votesKey, _this.get(_this.votesKey) + 1);
          }
        });
      };

      Place.prototype.setTodaysVotes = function() {
        var today, todaysVotes;
        today = moment().sod().valueOf();
        todaysVotes = _.reduce(this.get('votes'), function(memo, vote) {
          if (moment(vote.created).valueOf() > today) {
            return memo + 1;
          } else {
            return memo;
          }
        }, 0);
        return this.set(this.votesKey, todaysVotes || (todaysVotes = 0));
      };

      return Place;

    })(Model);
  });

}).call(this);
